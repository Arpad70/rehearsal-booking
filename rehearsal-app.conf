<VirtualHost *:80>
    ServerName rehearsal-app.local
    ServerAlias www.rehearsal-app.local
    ServerAdmin horak@localhost
    DocumentRoot /mnt/data/www/rehearsal-app/public

    # Laravel public directory
    <Directory /mnt/data/www/rehearsal-app/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Rewrite rules for Laravel
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            
            # Remove index.php from URL
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php/$1 [L]
        </IfModule>
    </Directory>

    # Deny access to Laravel app directory
    <Directory /mnt/data/www/rehearsal-app>
        Require all denied
    </Directory>

    # Deny access to sensitive files
    <Files ~ "\.(env|lock|sqlite|log)$">
        Require all denied
    </Files>

    # PHP-FPM configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost/"
    </FilesMatch>

    # Performance optimizations
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 2 days"
        
        # CSS, JavaScript
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"
        
        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        
        # Fonts
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/otf "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        
        # HTML, XML, JSON
        ExpiresByType text/html "access plus 0 seconds"
        ExpiresByType application/xml "access plus 0 seconds"
        ExpiresByType application/json "access plus 0 seconds"
    </IfModule>

    # Caching headers
    <IfModule mod_headers.c>
        # Disable caching for dynamic content
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        <FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|woff|woff2|ttf|otf|svg)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
    </IfModule>

    # Gzip compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # Security headers
    <IfModule mod_headers.c>
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-Content-Type-Options "nosniff"
        Header set X-XSS-Protection "1; mode=block"
        Header set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/rehearsal-app_error.log
    CustomLog ${APACHE_LOG_DIR}/rehearsal-app_access.log combined
    LogLevel warn
</VirtualHost>
